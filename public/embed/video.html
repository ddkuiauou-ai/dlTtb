<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <!-- 이 문서에서 발생하는 모든 하위 요청은 no-referrer -->
    <meta name="referrer" content="no-referrer" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>html,body{margin:0;height:100%;overflow:hidden} video{width:100%;height:100%;background:#000;object-fit:cover}</style>
  </head>
  <body>
    <!-- 쿼리로 mp4 URL을 전달받아 재생 -->
    <video id="v" controls playsinline preload="metadata" muted loop></video>
    <script>
      const params = new URLSearchParams(location.search);
      const src = params.get('src');
      const autoplay = params.get('autoplay') === '1';
      const video = document.getElementById('v');
      const origin = location.origin;

      if (src) {
        video.src = src;
      }

      let pendingCanPlayHandler = null;
      let lastRequested = autoplay ? 'play' : 'pause';

      const clearPending = () => {
        if (pendingCanPlayHandler) {
          video.removeEventListener('canplay', pendingCanPlayHandler);
          pendingCanPlayHandler = null;
        }
      };

      const requestPlay = () => {
        clearPending();
        const attempt = () => {
          const result = video.play();
          if (result && typeof result.catch === 'function') {
            result.catch(() => {});
          }
        };
        if (video.readyState >= 2) {
          attempt();
        } else {
          pendingCanPlayHandler = () => {
            pendingCanPlayHandler = null;
            if (lastRequested === 'play') {
              attempt();
            }
          };
          video.addEventListener('canplay', pendingCanPlayHandler, { once: true });
        }
      };

      const applyState = () => {
        if (lastRequested === 'play') {
          video.setAttribute('autoplay', '');
          requestPlay();
        } else {
          video.removeAttribute('autoplay');
          clearPending();
          video.pause();
        }
      };

      applyState();

      window.addEventListener('message', (event) => {
        if (event.origin && event.origin !== origin) return;
        const data = event.data;
        if (!data || typeof data !== 'object') return;
        const { type } = data;
        if (type === 'play' || type === 'pause') {
          if (lastRequested === type) return;
          lastRequested = type;
          applyState();
        }
      });
    </script>
  </body>
</html>
