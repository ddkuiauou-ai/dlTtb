name: Build Static JSON Content

on:
  # main 브랜치에 push가 있을 때 실행됩니다.
  push:
    branches:
      - main
  # GitHub Actions 탭에서 수동으로 실행할 수 있도록 합니다.
  workflow_dispatch:

# 동일한 브랜치에서 여러 워크플로우가 실행될 때 이전 실행을 취소
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 단일 스크립트들도 병렬로 빌드
  build_singular:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        task: ["search-index", "post-details", "keyword-pages"]
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate DB environment variables
        run: |
          missing=0
          for k in POSTGRES_HOST POSTGRES_PORT POSTGRES_USER POSTGRES_PASSWORD POSTGRES_DB; do
            if [ -z "${!k}" ]; then 
              echo "::error::$k is missing"
              missing=1
            fi
          done
          if [ $missing -ne 0 ]; then exit 1; fi
          echo "Database configuration validated"
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}

      - name: Build search index
        if: matrix.task == 'search-index'
        run: pnpm tsx scripts/build-search-index.ts
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      - name: Validate search index output
        if: matrix.task == 'search-index'
        run: test -f public/data/search-index.json

      - name: Build all post details
        if: matrix.task == 'post-details'
        run: pnpm tsx scripts/build-post-json.ts
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      - name: Validate post details output
        if: matrix.task == 'post-details'
        run: test -d public/data/posts/v1

      - name: Build all keyword pages
        if: matrix.task == 'keyword-pages'
        run: pnpm tsx scripts/build-keyword-json.ts
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      - name: Validate keyword pages output
        if: matrix.task == 'keyword-pages'
        run: test -d public/data/keywords

      - name: Upload singular build artifact (search-index)
        if: matrix.task == 'search-index'
        uses: actions/upload-artifact@v4
        with:
          name: artifact-singular-search-index
          path: public/data
          retention-days: 1
          if-no-files-found: error

      - name: Upload singular build artifact (post-details)
        if: matrix.task == 'post-details'
        uses: actions/upload-artifact@v4
        with:
          name: artifact-singular-post-details
          path: public/data
          retention-days: 1
          if-no-files-found: error

      - name: Upload singular build artifact (keyword-pages)
        if: matrix.task == 'keyword-pages'
        uses: actions/upload-artifact@v4
        with:
          name: artifact-singular-keyword-pages
          path: public/data
          retention-days: 1
          if-no-files-found: error

  # 'main' 페이지들을 병렬로 빌드하는 Job
  build_main:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        range: ["3h", "6h", "24h", "1w"]
        section: ["fresh", "trending", "top", "ranked"]
      fail-fast: false # 특정 조합이 실패해도 다른 조합은 계속 실행합니다.

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate DB environment variables
        run: |
          missing=0
          for k in POSTGRES_HOST POSTGRES_PORT POSTGRES_USER POSTGRES_PASSWORD POSTGRES_DB; do
            if [ -z "${!k}" ]; then 
              echo "::error::$k is missing"
              missing=1
            fi
          done
          if [ $missing -ne 0 ]; then exit 1; fi
          echo "Database configuration validated"
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      - name: Build main pages
        run: pnpm tsx scripts/build-main-json.ts
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          RANGE: ${{ matrix.range }}
          SECTION: ${{ matrix.section }}
      - name: Validate main pages output
        run: test -d "public/data/home/v1/${{ matrix.range }}/${{ matrix.section }}"
      - name: Upload main build artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact-main-${{ matrix.range }}-${{ matrix.section }}
          path: public/data
          retention-days: 1
          if-no-files-found: error

  # 'category' 페이지들을 병렬로 빌드하는 Job
  build_categories:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # 참고: 이 목록을 실제 사용하는 카테고리 목록으로 확장해야 합니다.
        category: ["all", "humor", "video", "youtube", "info", "it", "sports", "game", "qna", "review", "news", "debate", "back", "zzal", "politics", "shopping", "etc"]
        range: ["3h", "6h", "24h", "1w"]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate DB environment variables
        run: |
          missing=0
          for k in POSTGRES_HOST POSTGRES_PORT POSTGRES_USER POSTGRES_PASSWORD POSTGRES_DB; do
            if [ -z "${!k}" ]; then 
              echo "::error::$k is missing"
              missing=1
            fi
          done
          if [ $missing -ne 0 ]; then exit 1; fi
          echo "Database configuration validated"
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      - name: Build category pages
        run: pnpm tsx scripts/build-category-json.ts ${{ matrix.category }} ${{ matrix.range }}
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      - name: Validate category output
        run: test -d "public/data/category/${{ matrix.category }}/v1/${{ matrix.range }}"
      - name: Upload category artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact-category-${{ matrix.category }}-${{ matrix.range }}
          path: public/data
          retention-days: 1
          if-no-files-found: error

  # 'all-posts' 페이지들을 병렬로 빌드하는 Job
  build_all_posts:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        range: ["3h", "6h", "24h", "1w"]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate DB environment variables
        run: |
          missing=0
          for k in POSTGRES_HOST POSTGRES_PORT POSTGRES_USER POSTGRES_PASSWORD POSTGRES_DB; do
            if [ -z "${!k}" ]; then 
              echo "::error::$k is missing"
              missing=1
            fi
          done
          if [ $missing -ne 0 ]; then exit 1; fi
          echo "Database configuration validated"
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      - name: Build all posts pages
        run: pnpm tsx scripts/build-allposts-json.ts ${{ matrix.range }}
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      - name: Validate all-posts output
        run: test -d "public/data/all/v1/${{ matrix.range }}"
      - name: Upload all-posts artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact-allposts-${{ matrix.range }}
          path: public/data
          retention-days: 1
          if-no-files-found: error

  # 모든 빌드 Job이 완료된 후, 결과물들을 합치고 배포하는 Job
  package_and_deploy:
    runs-on: ubuntu-latest
    # 위에서 정의한 모든 빌드 Job들이 성공해야 이 Job이 실행됩니다.
    needs: [build_singular, build_main, build_categories, build_all_posts]
    permissions:
      contents: read
      deployments: write
    env:
      NEXT_TELEMETRY_DISABLED: "1"

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Combine artifacts
        run: |
          set -euo pipefail
          mkdir -p public/data
          echo "Merging build artifacts..."
          for d in artifacts/*/; do
            if [ -d "$d" ]; then
              rsync -a "$d" public/data/
            fi
          done
          echo "Artifacts merged successfully"

      - name: Validate environment variables
        run: |
          missing=0
          for k in POSTGRES_HOST POSTGRES_PORT POSTGRES_USER POSTGRES_PASSWORD POSTGRES_DB NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY; do
            if [ -z "${!k}" ]; then 
              echo "::error::$k is missing"
              missing=1
            fi
          done
          if [ $missing -ne 0 ]; then exit 1; fi
          echo "All environment variables validated"
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}

      - name: Build & Export Next.js
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
        run: |
          pnpm next build

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy out --project-name=${{ secrets.CLOUDFLARE_PAGES_PROJECT }}
          gitHubToken: ${{ secrets.TOKEN_GITHUB_COM }}