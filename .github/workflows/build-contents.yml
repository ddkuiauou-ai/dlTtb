name: Build Static JSON Content

on:
  # main ë¸Œëœì¹˜ì— pushê°€ ìˆì„ ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
  push:
    branches:
      - main
  # GitHub Actions íƒ­ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
  workflow_dispatch:

jobs:
  # ë‹¨ì¼ ìŠ¤í¬ë¦½íŠ¸ë“¤ë„ ë³‘ë ¬ë¡œ ë¹Œë“œ
  build_singular:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        task: ["search-index", "post-details", "keyword-pages"]
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check DB ENVs (masked-safe)
        run: |
          HOST='${{ secrets.POSTGRES_HOST }}'
          PORT='${{ secrets.POSTGRES_PORT }}'
          USER='${{ secrets.POSTGRES_USER }}'
          PASS='${{ secrets.POSTGRES_PASSWORD }}'
          DB='${{ secrets.POSTGRES_DB }}'

          missing=0
          for k in HOST PORT USER PASS DB; do
            v=$(eval echo \${$k})
            if [ -z "$v" ]; then echo "::error::$k is empty (missing corresponding secret)"; missing=1; fi
          done
          if [ $missing -ne 0 ]; then exit 1; fi

          echo "All Postgres secrets are set."
          echo "masked=postgresql://${USER:+***}@${HOST}${PORT:+:$PORT}/${DB}"
          echo "host=$HOST port=${PORT:-5432} user_set=$([ -n "$USER" ] && echo yes || echo no) db=$DB"
          echo "password_len=${#PASS}"
          echo "password_sha256=$(printf '%s' "$PASS" | sha256sum | cut -d' ' -f1)"

      - name: Build search index
        if: matrix.task == 'search-index'
        run: pnpm tsx scripts/build-search-index.ts
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      - name: Validate output layout
        if: matrix.task == 'search-index'
        run: |
          set -euo pipefail
          test -f public/data/search-index.json
          if [ -d public/data/v1 ]; then
            echo "::error::Found unexpected 'public/data/v1'. Producers must write under posts/v1 or proper subtrees."
            exit 1
          fi

      - name: Build all post details
        if: matrix.task == 'post-details'
        run: pnpm tsx scripts/build-post-json.ts
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      - name: Validate output layout
        if: matrix.task == 'post-details'
        run: |
          set -euo pipefail
          test -d public/data/posts/v1
          if [ -d public/data/v1 ]; then
            echo "::error::Found unexpected 'public/data/v1'. Producers must write under posts/v1."
            exit 1
          fi

      - name: Build all keyword pages
        if: matrix.task == 'keyword-pages'
        run: pnpm tsx scripts/build-keyword-json.ts
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      - name: Validate output layout
        if: matrix.task == 'keyword-pages'
        run: |
          set -euo pipefail
          test -d public/data/keywords
          if [ -d public/data/v1 ]; then
            echo "::error::Found unexpected 'public/data/v1'. Producers must write under proper subtrees."
            exit 1
          fi

      - name: Upload singular build artifact (search-index)
        if: matrix.task == 'search-index'
        uses: actions/upload-artifact@v4
        with:
          name: artifact-singular-search-index
          path: public/data
          if-no-files-found: error

      - name: Upload singular build artifact (post-details)
        if: matrix.task == 'post-details'
        uses: actions/upload-artifact@v4
        with:
          name: artifact-singular-post-details
          path: public/data
          if-no-files-found: error

      - name: Upload singular build artifact (keyword-pages)
        if: matrix.task == 'keyword-pages'
        uses: actions/upload-artifact@v4
        with:
          name: artifact-singular-keyword-pages
          path: public/data
          if-no-files-found: error

  # 'main' í˜ì´ì§€ë“¤ì„ ë³‘ë ¬ë¡œ ë¹Œë“œí•˜ëŠ” Job
  build_main:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        range: ["3h", "6h", "24h", "1w"]
        section: ["fresh", "trending", "top", "ranked"]
      fail-fast: false # íŠ¹ì • ì¡°í•©ì´ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ì¡°í•©ì€ ê³„ì† ì‹¤í–‰í•©ë‹ˆë‹¤.

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check DB ENVs (masked-safe)
        run: |
          HOST='${{ secrets.POSTGRES_HOST }}'
          PORT='${{ secrets.POSTGRES_PORT }}'
          USER='${{ secrets.POSTGRES_USER }}'
          PASS='${{ secrets.POSTGRES_PASSWORD }}'
          DB='${{ secrets.POSTGRES_DB }}'

          missing=0
          for k in HOST PORT USER PASS DB; do
            v=$(eval echo \${$k})
            if [ -z "$v" ]; then echo "::error::$k is empty (missing corresponding secret)"; missing=1; fi
          done
          if [ $missing -ne 0 ]; then exit 1; fi

          echo "All Postgres secrets are set."
          # Show masked summary without leaking password
          echo "masked=postgresql://${USER:+***}@${HOST}${PORT:+:$PORT}/${DB}"
          # Show non-sensitive breakdown
          echo "host=$HOST port=${PORT:-5432} user_set=$([ -n "$USER" ] && echo yes || echo no) db=$DB"
          # Password diagnostics without revealing
          echo "password_len=${#PASS}"
          echo "password_sha256=$(printf '%s' "$PASS" | sha256sum | cut -d' ' -f1)"
      - name: Build main pages
        run: pnpm tsx scripts/build-main-json.ts
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          RANGE: ${{ matrix.range }}
          SECTION: ${{ matrix.section }}

      - name: "ğŸ DEBUG - List generated files"
        run: |
          echo "--- Listing files in public/data/home/v1 ---"
          find public/data/home/v1 -ls
      - name: Validate output layout
        run: |
          set -euo pipefail
          test -d "public/data/home/v1/${{ matrix.range }}/${{ matrix.section }}"
          if [ -d public/data/v1 ]; then
            echo "::error::Found unexpected 'public/data/v1'."
            exit 1
          fi
      - name: Upload main build artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact-main-${{ matrix.range }}-${{ matrix.section }}
          path: public/data

  # 'category' í˜ì´ì§€ë“¤ì„ ë³‘ë ¬ë¡œ ë¹Œë“œí•˜ëŠ” Job
  build_categories:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # ì°¸ê³ : ì´ ëª©ë¡ì„ ì‹¤ì œ ì‚¬ìš©í•˜ëŠ” ì¹´í…Œê³ ë¦¬ ëª©ë¡ìœ¼ë¡œ í™•ì¥í•´ì•¼ í•©ë‹ˆë‹¤.
        category: ["all", "video", "youtube"]
        range: ["3h", "6h", "24h", "1w"]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check DB ENVs (masked-safe)
        run: |
          HOST='${{ secrets.POSTGRES_HOST }}'
          PORT='${{ secrets.POSTGRES_PORT }}'
          USER='${{ secrets.POSTGRES_USER }}'
          PASS='${{ secrets.POSTGRES_PASSWORD }}'
          DB='${{ secrets.POSTGRES_DB }}'

          missing=0
          for k in HOST PORT USER PASS DB; do
            v=$(eval echo \${$k})
            if [ -z "$v" ]; then echo "::error::$k is empty (missing corresponding secret)"; missing=1; fi
          done
          if [ $missing -ne 0 ]; then exit 1; fi

          echo "All Postgres secrets are set."
          # Show masked summary without leaking password
          echo "masked=postgresql://${USER:+***}@${HOST}${PORT:+:$PORT}/${DB}"
          # Show non-sensitive breakdown
          echo "host=$HOST port=${PORT:-5432} user_set=$([ -n "$USER" ] && echo yes || echo no) db=$DB"
          # Password diagnostics without revealing
          echo "password_len=${#PASS}"
          echo "password_sha256=$(printf '%s' "$PASS" | sha256sum | cut -d' ' -f1)"
      - name: Build category pages
        run: pnpm tsx scripts/build-category-json.ts ${{ matrix.category }} ${{ matrix.range }}
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      - name: Validate output layout
        run: |
          set -euo pipefail
          test -d "public/data/category/${{ matrix.category }}/v1/${{ matrix.range }}"
          if [ -d public/data/v1 ]; then
            echo "::error::Found unexpected 'public/data/v1'."
            exit 1
          fi
      - name: Upload category artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact-category-${{ matrix.category }}-${{ matrix.range }}
          path: public/data

  # 'all-posts' í˜ì´ì§€ë“¤ì„ ë³‘ë ¬ë¡œ ë¹Œë“œí•˜ëŠ” Job
  build_all_posts:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        range: ["3h", "6h", "24h", "1w"]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check DB ENVs (masked-safe)
        run: |
          HOST='${{ secrets.POSTGRES_HOST }}'
          PORT='${{ secrets.POSTGRES_PORT }}'
          USER='${{ secrets.POSTGRES_USER }}'
          PASS='${{ secrets.POSTGRES_PASSWORD }}'
          DB='${{ secrets.POSTGRES_DB }}'

          missing=0
          for k in HOST PORT USER PASS DB; do
            v=$(eval echo \${$k})
            if [ -z "$v" ]; then echo "::error::$k is empty (missing corresponding secret)"; missing=1; fi
          done
          if [ $missing -ne 0 ]; then exit 1; fi

          echo "All Postgres secrets are set."
          # Show masked summary without leaking password
          echo "masked=postgresql://${USER:+***}@${HOST}${PORT:+:$PORT}/${DB}"
          # Show non-sensitive breakdown
          echo "host=$HOST port=${PORT:-5432} user_set=$([ -n "$USER" ] && echo yes || echo no) db=$DB"
          # Password diagnostics without revealing
          echo "password_len=${#PASS}"
          echo "password_sha256=$(printf '%s' "$PASS" | sha256sum | cut -d' ' -f1)"
      - name: Build all posts pages
        run: pnpm tsx scripts/build-allposts-json.ts ${{ matrix.range }}
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      - name: Validate output layout
        run: |
          set -euo pipefail
          test -d "public/data/all/v1/${{ matrix.range }}"
          if [ -d public/data/v1 ]; then
            echo "::error::Found unexpected 'public/data/v1'."
            exit 1
          fi
      - name: Upload all-posts artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact-allposts-${{ matrix.range }}
          path: public/data

  # ëª¨ë“  ë¹Œë“œ Jobì´ ì™„ë£Œëœ í›„, ê²°ê³¼ë¬¼ë“¤ì„ í•˜ë‚˜ë¡œ í•©ì¹˜ëŠ” Job
  package:
    runs-on: ubuntu-latest
    # ìœ„ì—ì„œ ì •ì˜í•œ ëª¨ë“  ë¹Œë“œ Jobë“¤ì´ ì„±ê³µí•´ì•¼ ì´ Jobì´ ì‹¤í–‰ë©ë‹ˆë‹¤.
    needs: [build_singular, build_main, build_categories, build_all_posts]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          # ëª¨ë“  ì•„í‹°íŒ©íŠ¸ë¥¼ 'artifacts' í´ë” ì•„ë˜ì— ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.
          path: artifacts

      - name: Combine artifacts
        run: |
          set -euo pipefail
          mkdir -p public/data
          echo "--- Merging all artifact contents into ./public/data ---"
          find artifacts -mindepth 1 -maxdepth 1 -type d -exec rsync -av --remove-source-files {}/ public/ \;
          echo "--- Final public directory tree ---"
          ls -lR public

      - name: Upload final public-data artifact
        uses: actions/upload-artifact@v4
        with:
          name: public-data
          path: public/data/**

  # ëª¨ë“  ì•„í‹°íŒ©íŠ¸ë¥¼ í•©ì¹œ í›„ Cloudflare Pagesë¡œ ë°°í¬
  deploy:
    runs-on: ubuntu-latest
    needs: package
    permissions:
      contents: read
      deployments: write
    env:
      DISABLE_DB_AT_BUILD: "0"
      NEXT_TELEMETRY_DISABLED: "1"

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download final public-data artifact
        uses: actions/download-artifact@v4
        with:
          name: public-data
          path: public/data

      - name: Check DB ENVs (masked-safe)
        run: |
          HOST='${{ secrets.POSTGRES_HOST }}'
          PORT='${{ secrets.POSTGRES_PORT }}'
          USER='${{ secrets.POSTGRES_USER }}'
          PASS='${{ secrets.POSTGRES_PASSWORD }}'
          DB='${{ secrets.POSTGRES_DB }}'

          missing=0
          for k in HOST PORT USER PASS DB; do
            v=$(eval echo \${$k})
            if [ -z "$v" ]; then echo "::error::$k is empty (missing corresponding secret)"; missing=1; fi
          done
          if [ $missing -ne 0 ]; then exit 1; fi

          echo "All Postgres secrets are set."
          echo "masked=postgresql://${USER:+***}@${HOST}${PORT:+:$PORT}/${DB}"
          echo "host=$HOST port=${PORT:-5432} user_set=$([ -n "$USER" ] && echo yes || echo no) db=$DB"
          echo "password_len=${#PASS}"
          echo "password_sha256=$(printf '%s' "$PASS" | sha256sum | cut -d' ' -f1)"

      - name: Build & Export Next.js
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          DISABLE_DB_AT_BUILD: ${{ env.DISABLE_DB_AT_BUILD }}
        run: |
          pnpm next build

      - name: Print working dir and tree
        run: |
          set -x
          echo "PWD:"
          pwd
          echo "--- Top level ---"
          ls -lah || true
          echo "--- public (pre-build copy result) ---"
          ls -lah public || true
          echo "--- public/data sample ---"
          ls -lah public/data || true
          ls -lah public/data/posts/v1 || true
          echo "--- out (exported) ---"
          ls -lah out || true
          echo "--- out/data/posts/v1 ---"
          ls -lah out/data/posts/v1 || true

      - name: Sanity check exported assets
        run: |
          set -e
          # Verify export root exists
          test -f out/index.html
          # Verify at least one post JSON exists at the expected path
          if compgen -G "out/data/posts/v1/*.json" >/dev/null; then
            echo "OK: found JSON in out/data/posts/v1"
            ls -lah out/data/posts/v1 | head -n 50 || true
          else
            echo "::error::No JSON files found in out/data/posts/v1"
            echo "Directory listing for troubleshooting:"
            ls -lah out || true
            ls -lah out/data || true
            ls -lah out/data/posts || true
            exit 1
          fi

      - name: Build diagnostics (DB at build?)
        run: |
          echo "DISABLE_DB_AT_BUILD=${DISABLE_DB_AT_BUILD:-unset}"
          if [ "${DISABLE_DB_AT_BUILD}" = "1" ]; then
            echo "App SHOULD NOT connect to DB during build. Ensure generateStaticParams/Metadata are guarded."
          else
            echo "App MAY connect to DB during build."
          fi

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          # í”„ë¡œì íŠ¸ëª…ì€ ë ˆí¬ ì‹œí¬ë¦¿ìœ¼ë¡œ ê´€ë¦¬í•˜ê±°ë‚˜ ì§ì ‘ ë¬¸ìì—´ë¡œ ê¸°ì…í•˜ì„¸ìš”.
          command: pages deploy out --project-name=${{ secrets.CLOUDFLARE_PAGES_PROJECT }}
          gitHubToken: ${{ secrets.TOKEN_GITHUB_COM }}
